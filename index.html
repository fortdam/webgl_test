<html>

<head>
<title>t3d test</title>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
<script src="t3d.js"></script>
<script type="text/javascript">


    var projectionMatrix;

    function initMatrices(x,y,z)
    {
         var mat = new t3d.Matrix();
         projectionMatrix = mat.rotate(x,y,z).lookAt(0,0,2.5).frustum(-1,1,-1,1,1,100).toGLArray();        
    }

    // Create the vertex data for a square to be drawn
    function createSquare(gl) {
        var vertexBuffer;
            vertexBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, vertexBuffer);
        var verts = [
             .8, .8, 0.0,
            -.8, .8, 0.0,
             .8, -.8, 0.0,
            -.8, -.8, 0.0
        ];
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(verts), gl.STATIC_DRAW);
        var square = {buffer:vertexBuffer, vertSize:3, nVerts:4, primtype:gl.TRIANGLE_STRIP};
        return square;
    }


    
        var vertexShaderSource =
                
                " attribute vec3 vertexPos;\n" +
                " uniform mat4 projectionMatrix;\n" +
                " void main(void) {\n" +
                "                // Return the transformed and projected vertex value\n" +
                " gl_Position = projectionMatrix * \n" +
                " vec4(vertexPos, 1.0);\n" +
                " }\n";

        var fragmentShaderSource =
                " precision mediump float;\n" +
                " uniform vec4 ccolor;\n" +
                " void main(void) {\n" +
                " // Return the pixel color: always output white\n" +
        " gl_FragColor = ccolor;\n" +
            "}\n";


    var shaderProgram, shaderVertexPositionAttribute, shaderProjectionMatrixUniform ;
    var shaderColorUniform;

    function initShader(gl) {
        try {
        shaderProgram = t3d.setupProgram(vertexShaderSource, fragmentShaderSource);

}
catch (e)
{
    alert(e.toString());
}    

// get pointers to the shader params
        shaderVertexPositionAttribute = gl.getAttribLocation(shaderProgram, "vertexPos");
        gl.enableVertexAttribArray(shaderVertexPositionAttribute);
        
        shaderProjectionMatrixUniform = gl.getUniformLocation(shaderProgram, "projectionMatrix");
        shaderColorUniform = gl.getUniformLocation(shaderProgram, "ccolor");
        
    }

     function draw(gl, obj, color) {

         // clear the background (with black)
         gl.clearColor(0.0, 0.0, 0.0, 1.0);
         gl.clear(gl.COLOR_BUFFER_BIT);

             // set the vertex buffer to be drawn
         gl.bindBuffer(gl.ARRAY_BUFFER, obj.buffer);

         // set the shader to use
         gl.useProgram(shaderProgram);

                 // connect up the shader parameters: vertex position and projection/model matrices
         gl.vertexAttribPointer(shaderVertexPositionAttribute, obj.vertSize, gl.FLOAT, false, 0, 0);
         gl.uniformMatrix4fv(shaderProjectionMatrixUniform, false, projectionMatrix);
         gl.uniform4f(shaderColorUniform, color, color, color, 1.0);

         // draw the object
         gl.drawArrays(obj.primtype, 0, obj.nVerts);
      }
          
    function onLoad() {
        var canvas = document.getElementById("webglcanvas");
        try {
        var gl = t3d.init(canvas);
  
        initMatrices(0,0,0);
        
        var square = createSquare(gl);
        
        initShader(gl);
        draw(t3d.getGL(), square, 1.0);
        
        var colorStep = 1.0;
        var xD = 0;
        var yD = 0; 
        var zD = 0;
        
        window.setInterval(function(){
                xD += 2;
                yD += 3
                zD += 4;

                xD = (xD>180)?-180:xD;
                yD = (yD>180)?-180:yD;
                zD = (zD>180)?-180:zD;

                initMatrices(xD, yD, zD);

                colorStep -= 0.1; 
                //colorStep = (colorStep<=0)?1.0:colorStep;

                colorStep = 0.8;
                
                draw(t3d.getGL(), square, colorStep)
            }, 20);
         }
        catch(e) {
        alert("Error" + e.toString());
        }
    }


</script>


</head>


<body onload="onLoad();">

    <canvas id="webglcanvas" style="border: none;" width="500" height="500"></canvas>

</body>

</html>


