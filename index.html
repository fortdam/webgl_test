<html>

<head>
<title>t3d test</title>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
<script src="t3d.js"></script>
<script type="text/javascript">


    var projectionMatrix, modelViewMatrix;

    function initMatrices()
    {
         // The transform matrix for the square - translate back in Z for the camera
         modelViewMatrix = new Float32Array(
         [1, 0, 0, 0,
         0, 1, 0, 0,
         0, 0, 1, 0,
         0, 0, -3.333, 1]);
       
         // The projection matrix (for a 45 degree field of view)
         projectionMatrix = new Float32Array(
         [2.41421, 0, 0, 0,
         0, 2.41421, 0, 0,
         0, 0, -1.002002, -1,
         0, 0, -0.2002002, 0]);
        
    }

    // Create the vertex data for a square to be drawn
    function createSquare(gl) {
        var vertexBuffer;
            vertexBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, vertexBuffer);
        var verts = [
             .5, .5, 0.0,
            -.5, .5, 0.0,
             .5, -.5, 0.0,
            -.5, -.5, 0.0
        ];
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(verts), gl.STATIC_DRAW);
        var square = {buffer:vertexBuffer, vertSize:3, nVerts:4, primtype:gl.TRIANGLE_STRIP};
        return square;
    }


    
        var vertexShaderSource =
                
                " attribute vec3 vertexPos;\n" +
                " uniform mat4 modelViewMatrix;\n" +
                " uniform mat4 projectionMatrix;\n" +
                " void main(void) {\n" +
                "                // Return the transformed and projected vertex value\n" +
                " gl_Position = projectionMatrix * modelViewMatrix * \n" +
                " vec4(vertexPos, 1.0);\n" +
                " }\n";

        var fragmentShaderSource =
                " precision mediump float;\n" +
                " uniform vec4 ccolor;\n" +
                " void main(void) {\n" +
                " // Return the pixel color: always output white\n" +
        " gl_FragColor = ccolor;\n" +
            "}\n";


    var shaderProgram, shaderVertexPositionAttribute, shaderProjectionMatrixUniform, shaderModelViewMatrixUniform;
    var shaderColorUniform;

    function initShader(gl) {
        try {
        shaderProgram = t3d.setupProgram(vertexShaderSource, fragmentShaderSource);

}
catch (e)
{
    alert(e.toString());
}    

// get pointers to the shader params
        shaderVertexPositionAttribute = gl.getAttribLocation(shaderProgram, "vertexPos");
        gl.enableVertexAttribArray(shaderVertexPositionAttribute);
        
        shaderProjectionMatrixUniform = gl.getUniformLocation(shaderProgram, "projectionMatrix");
        shaderModelViewMatrixUniform = gl.getUniformLocation(shaderProgram, "modelViewMatrix");
        shaderColorUniform = gl.getUniformLocation(shaderProgram, "ccolor");
        
    }

     function draw(gl, obj, color) {

         // clear the background (with black)
         gl.clearColor(0.0, 0.0, 0.0, 1.0);
         gl.clear(gl.COLOR_BUFFER_BIT);

             // set the vertex buffer to be drawn
         gl.bindBuffer(gl.ARRAY_BUFFER, obj.buffer);

         // set the shader to use
         gl.useProgram(shaderProgram);

                 // connect up the shader parameters: vertex position and projection/model matrices
         gl.vertexAttribPointer(shaderVertexPositionAttribute, obj.vertSize, gl.FLOAT, false, 0, 0);
         gl.uniformMatrix4fv(shaderProjectionMatrixUniform, false, projectionMatrix);
         gl.uniformMatrix4fv(shaderModelViewMatrixUniform, false, modelViewMatrix);
         gl.uniform4f(shaderColorUniform, color, color, color, 1.0);

         // draw the object
         gl.drawArrays(obj.primtype, 0, obj.nVerts);
      }
          
    function onLoad() {
        var canvas = document.getElementById("webglcanvas");
        
        var gl = t3d.init(canvas);
  
        initMatrices();
        
        var square = createSquare(gl);
        
        initShader(gl);
        draw(t3d.getGL(), square, 1.0);
        
        var colorStep = 1.0;
        
        window.setInterval(function(){colorStep -= 0.1; colorStep = (colorStep<=0)?1.0:colorStep; draw(t3d.getGL(), square, colorStep)}, 200);
    }


</script>


</head>


<body onload="onLoad();">

    <canvas id="webglcanvas" style="border: none;" width="500" height="500"></canvas>

</body>

</html>

